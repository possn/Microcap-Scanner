name: microcap-scanner-daily

on:
  workflow_dispatch: {}
  schedule:
    # Dias úteis, 13:20 UTC (Portugal no inverno = UTC).
    # Dá tempo para o EOD do dia anterior já estar disponível no Stooq
    # e ainda fica antes da abertura US (14:30 UTC no inverno).
    - cron: "20 13 * * 1-5"

permissions:
  contents: write

concurrency:
  group: microcap-scanner-daily
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run scanner (pre-open, EOD prior day)
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}

          IWC_HOLDINGS_CSV_URL: ${{ secrets.IWC_HOLDINGS_CSV_URL }}
          IWM_HOLDINGS_CSV_URL: ${{ secrets.IWM_HOLDINGS_CSV_URL }}
          IJR_HOLDINGS_CSV_URL: ${{ secrets.IJR_HOLDINGS_CSV_URL }}

          # IMPORTANTE: não forces OHLCV_URL_FMT via secret se ele puder estar vazio.
          # Se quiseres mesmo, garante que o secret está preenchido.
          # OHLCV_URL_FMT: ${{ secrets.OHLCV_URL_FMT }}

          # Preferência: puxar dados novos (fallback para cache se houver rate-limit)
          CACHE_ONLY: "0"

          # Universe / velocidade
          MAX_TICKERS: "450"
          CANDIDATE_POOL: "2000"
          SLEEP_EVERY: "25"
          SLEEP_SECONDS: "2.0"

          # Filtros relaxados (para saírem ideias diariamente)
          MIN_PX: "1.0"
          MAX_PX: "30"

          MIN_DV20: "1500000"
          MAX_DV20: "120000000"
          MIN_SV20: "250000"

          # Compressão mais permissiva
          BBZ_GATE: "-0.60"
          ATRPCTL_GATE: "0.50"

          # Base/dry permissivo
          BASE_DD_MAX: "0.62"
          CONTRACTION_MAX: "0.92"
          DRYUP_MAX: "1.10"

          # Exec / watch mais permissivo
          VOL_CONFIRM_MULT: "1.12"
          MAX_GAP_UP: "1.14"
          DIST_MAX_PCT: "18.0"
          EXEC_MAX_OVERSHOOT_PCT: "8.0"

          EXEC_BBZ_MAX: "-0.90"
          EXEC_ATRPCTL_MAX: "0.38"

          MIN_R_PCT: "6.0"

          OVERHEAD_WINDOW: "200"
          OVERHEAD_BAND_PCT: "8.0"
          OVERHEAD_MAX_TOUCHES: "12"

          WATCH_BOOST_MIN_DAYS: "3"
          WATCH_STALE_DAYS: "10"

          HORIZON_SESS: "40"
          REG_QQQ: "QQQ"
          REG_VIX: "VIX"
        run: |
          python scanner.py

      - name: Commit cache outputs (signals + ohlcv)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git pull --rebase || true

          git add cache/signals.csv cache/ohlcv || true
          git commit -m "Update cache (signals + ohlcv)" || exit 0
          git push
